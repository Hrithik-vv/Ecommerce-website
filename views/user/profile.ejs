<%- include("../../views/partials/user/header") %>
  <style>
    .card-green {
      background-color: #ADD8E6;
    }

    .main {
      padding: 30px 0;
    }


    .dashboard-menu {
      background-color: #cce3e6;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }


    .dashboard-menu .nav-link {
      font-weight: bold;
      color: #30683c;
      box-shadow: 0 4px 10px rgba(123, 131, 112, 0.3), 0 4px 20px rgba(0, 191, 255, 0.2);
      transition: box-shadow 0.3s ease;
    }


    .dashboard-menu .nav-link:hover {
      color: #00bfff;
      box-shadow: 0 4px 15px rgba(173, 255, 47, 0.5), 0 6px 25px rgba(0, 191, 255, 0.4);
    }


    .card {
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
    }


    .card-header {
      background-color: #487379;
      color: white;
      border-radius: 10px 10px 0 0;
    }


    .btn-success {
      background-color: #577194;
      border-color: #6bb87d;
    }


    .btn-success:hover {
      background-color: #506955;
    }


    .form-group {
      margin-bottom: 15px;
    }


    .required {
      color: red;
    }


    @media (max-width: 768px) {
      .dashboard-menu {
        padding: 10px;
      }


      .card {
        margin-bottom: 15px;
      }
    }

    .page-header.breadcrumb-wrap {
      background-color: #eee2e9;
      padding: 15px 0;
    }


    .breadcrumb {
      display: flex;
      align-items: center;
      font-family: 'Arial', sans-serif;
      font-size: 16px;
      color: #121311;
    }


    .breadcrumb a {
      color: #007bff;
      text-decoration: none;
      position: relative;
      margin: 0 5px;
    }


    .breadcrumb a:hover {
      color: #0056b3;
    }


    .breadcrumb span {
      margin: 0 5px;
      color: #999;
    }


    .breadcrumb a::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: #6e6e3a;
      left: 0;
      bottom: -2px;
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }


    .breadcrumb a:hover::after {
      transform: scaleX(1);
    }

    .pagination-buttons .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .transaction-history {
      min-height: 400px;
      position: relative;
    }

    .badge {
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
    }

    .table td {
      vertical-align: middle;
    }
  </style>

  <main class="main">
    <div class="page-header breadcrumb-wrap mb-3">
      <div class="container">
        <div class="breadcrumb">
          <a href="/" rel="nofollow">Home</a>
          <span></span> Profile <span></span>
        </div>
      </div>
    </div>
    <section class="pt-10 pb-10">
      <div class="container">
        <div class="row">
          <div class="col-lg-10 m-auto">
            <div class="row">
              <div class="col-md-4">
                <div class="dashboard-menu">
                  <ul class="nav flex-column" role="tablist">
                    <li class="nav-item">
                      <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab"
                        aria-controls="dashboard" aria-selected="false">
                        <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab"
                        aria-controls="address" aria-selected="true">
                        <i class="fi-rs-marker mr-10"></i>My Address
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" id="orders-tab" href="/order-history" 
                        aria-controls="orders" aria-selected="false">
                        <i class="fi-rs-shopping-bag mr-10"></i>Orders
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab"
                        aria-controls="track-orders" aria-selected="false">
                        <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet Status
                      </a>
                    </li>
                    <li class="nav-item">
                      <!-- <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#wallet-history" role="tab"
                        aria-controls="track-orders" aria-selected="false">
                        <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet History
                      </a> -->
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" id="referral-tab" data-bs-toggle="tab" href="#referral" role="tab"
                        aria-controls="referral" aria-selected="false">
                        <i class="fi-rs-share mr-10"></i>Referrals
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="/logout">
                        <i class="fi-rs-sign-out mr-10"></i>Logout
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="col-md-8">
                <div class="tab-content dashboard-content">


                  <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                    <div class="card card-green">
                      <div class="card-header">
                        <h5 class="mb-0 text-center">User Profile</h5>
                      </div>
                      <div class="card-body text-center">
                        <h5 class="card-title">
                          <%=user.name%>
                        </h5>
                        <!-- <p class="card-text">
                          <strong>Phone:</strong>
                        </p> -->
                        <p class="card-text">
                          <strong>Email:</strong>
                          <%=user.email%>
                        </p>
                        <a href="/direct-email-change" class="btn btn-sm btn-success ml-2">Change Email</a>
                        <a href="/change-password" class="btn btn-sm btn-success">Change Password</a>
                      </div>
                    </div>
                  </div>


                  <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                    <div class="row">
                      <%if(addresses && addresses.length > 0){%>
                        <%addresses.forEach((address)=>{%>
                          <%address.address.forEach((addr)=>{%>
                            <div class="col-lg-6">
                              <div class="card mb-3 mb-lg-0">
                                <div class="card-header">
                                  <h5 class="mb-0"><%=addr.addressType%></h5>
                                </div>

                                <div class="card-body">
                                  <address>
                                    <%=addr.name%><br/>
                                    <%=addr.city%><br/>
                                    <%=addr.landMark%><br/>
                                    <%=addr.state%>
                                  </address>
                                  <p><%=addr.pincode%></p>
                                  <p><%=addr.phone%></p>
                                  <p><%=addr.altPhone%></p>
                                  <div class="d-flex justify-content-between">
                                    <a href="/editAddress?id=<%=addr._id%>" class="btn-small">Edit</a>
                                    <a href="/deleteAddress?id=<%=addr._id%>" class="btn-small" onclick="return confirm('Are you sure you want to delete this address?')">Delete</a>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <%})%>
                        <%})%>
                      <%}else{%>
                        <div class="col-lg-6">
                          <div class="card mb-3 mb-lg-0">
                            <div class="card-header">
                              <h5 class="mb-0"></h5>
                            </div>
                            <div class="card-body">
                              <address>No address</address>
                            </div>
                          </div>
                        </div>
                      <%}%>
                      <div class="address-btn">
                        <a href="/addAddress">
                          <button class="btn btn-primary w-70">
                            Add address
                          </button>
                        </a>
                      </div>
                    </div>
                  </div>


                  <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                    <div class="card">
                      <div class="card-header">
                        <h5 class="mb-0">Your Orders</h5>
                      </div>
                      <div class="card-body">
                        <div class="table-responsive">
                          <table class="table">
                            <thead>
                              <tr>
                                <th>Order</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Actions</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>
                                  <button onclick="viewOrderDetails('orderId')" class="btn-small d-block">View</button>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        
                        <!-- Order Details Section (Initially Hidden) -->
                        <div id="orderDetailsSection" style="display: none;" class="mt-4">
                          <div class="card">
                            <div class="card-header">
                              <h5 class="mb-0">Order Details</h5>
                            </div>
                            <div class="card-body" id="orderDetailsContent">
                              <!-- Content will be loaded here -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>


                  <% if (wallet) { %>
                    <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                      <div class="card" style="width: fit-content; margin: 0 auto;">
                        <div class="card-header">
                          <h3 class="mb-0 text-center">My Wallet</h3>
                        </div>
                        <div class="card-body">
                          <!-- Balance Section -->
                          <div class="wallet-balance text-center mb-4">
                            <h5>Available Balance</h5>
                            <div class="h2 text-success">₹<%= wallet.balance %></div>
                          </div>
                  
                          <!-- Transaction History -->
                          <div class="transaction-history">
                            <h5 class="text-center mb-3">Transaction History</h5>
                            <table class="table">
                              <thead>
                                <tr>
                                  <th>Transaction ID</th>
                                  <th>Date</th>
                                  <th>Description</th>
                                  <th>Type</th>
                                  <th>Amount</th>
                                </tr>
                              </thead>
                              <tbody id="transactionTableBody">
                                <!-- Table body will be populated by JavaScript -->
                              </tbody>
                            </table>

                            <!-- Pagination -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                              <div class="pagination-info">
                                Showing <span id="startIndex">0</span> to <span id="endIndex">0</span> of <span id="totalItems">0</span> transactions
                              </div>
                              <div class="pagination-buttons">
                                <button id="prevPage" class="btn btn-sm btn-outline-primary me-2">&laquo; Previous</button>
                                <button id="nextPage" class="btn btn-sm btn-outline-primary">Next &raquo;</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% } %>
                  




                  <div class="tab-pane fade" id="referral" role="tabpanel" aria-labelledby="referral-tab">
                    <div class="card">
                      <div class="card-header">
                        <h3 class="mb-0 text-center">My Referrals</h3>
                      </div>
                      <div class="card-body">
                        <div class="text-center mb-4">
                          <h5>Your Referral Code</h5>
                          <div class="d-flex justify-content-center align-items-center">
                            <div class="input-group" style="max-width: 300px;">
                              <input type="text" class="form-control" id="referralCode" value="<%= user.referalCode || 'No referral code available' %>" readonly>
                              <button class="btn btn-outline-secondary" type="button" id="copyCodeBtn" onclick="copyReferralCode()">
                                <i class="fi-rs-copy"></i> Copy
                              </button>
                            </div>
                          </div>
                        </div>

                        <div class="text-center mb-4">
                          <h5>Share Your Referral Link</h5>
                          <div class="d-flex justify-content-center align-items-center">
                            <div class="input-group" style="max-width: 300px;">
                              <input type="text" class="form-control" id="referralLink" 
                                value="<%= user.referalCode ? `${process.env.BASE_URL || 'http://localhost:3000'}/signup?ref=${user.referalCode}` : 'No referral link available' %>" readonly>
                              <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn" onclick="copyReferralLink()">
                                <i class="fi-rs-copy"></i> Copy
                              </button>
                            </div>
                          </div>
                        </div>

                        <div class="text-center mb-4">
                          <h5>Referral Benefits</h5>
                          <p>Earn ₹50 in your wallet for each friend who signs up using your referral code!</p>
                        </div>

                        <% if (user.redeemedUsers && user.redeemedUsers.length > 0) { %>
                        <div class="referred-users mt-4">
                          <h5>Successful Referrals</h5>
                          <div class="table-responsive">
                            <table class="table">
                              <thead>
                                <tr>
                                  <th>No.</th>
                                  <th>User</th>
                                  <th>Date</th>
                                  <th>Reward</th>
                                </tr>
                              </thead>
                              <tbody>
                                <% user.redeemedUsers.forEach((referredUser, index) => { %>
                                <tr>
                                  <td><%= index + 1 %></td>
                                  <td><%= referredUser.email || 'User' %></td>
                                  <td><%= new Date(referredUser.createdAt || Date.now()).toLocaleDateString() %></td>
                                  <td>₹50</td>
                                </tr>
                                <% }); %>
                              </tbody>
                            </table>
                          </div>
                        </div>
                        <% } else { %>
                        <div class="no-referrals text-center">
                          <p>You haven't referred anyone yet. Share your referral code to start earning rewards!</p>
                        </div>
                        <% } %>

                        <div class="social-sharing text-center mt-4">
                          <h5>Share on Social Media</h5>
                          <div class="d-flex justify-content-center">
                            <a href="javascript:void(0)" onclick="shareOnWhatsApp()" class="btn btn-outline-success me-2">
                              <i class="fa fa-whatsapp"></i> WhatsApp
                            </a>
                            <a href="javascript:void(0)" onclick="shareOnFacebook()" class="btn btn-outline-primary me-2">
                              <i class="fa fa-facebook"></i> Facebook
                            </a>
                            <a href="javascript:void(0)" onclick="shareOnTwitter()" class="btn btn-outline-info">
                              <i class="fa fa-twitter"></i> Twitter
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
    </section>
  </main>
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  function viewOrderDetails(orderId) {
      // Show loading state
      const detailsSection = document.getElementById('orderDetailsSection');
      const detailsContent = document.getElementById('orderDetailsContent');
      detailsSection.style.display = 'block';
      detailsContent.innerHTML = 'Loading...';

      // Fetch order details
      fetch(`/order-details/${orderId}`)
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Create HTML content for order details
                  const html = `
                      <div class="container">
                          <div class="row">
                              <div class="col-12">
                                  <h2 class="text-xl font-semibold">
                                      <i class="fas fa-box-open text-primary mr-2"></i>
                                      ${data.product.productName}
                                  </h2>
                                  <p class="text-muted">Status: ${data.order.status}</p>
                                  
                                  <div class="product-info mt-4">
                                      <div class="d-flex align-items-center">
                                          <img src="${data.product.image1}" 
                                               class="img-thumbnail" 
                                               style="width: 100px; height: 100px; object-fit: cover;"
                                               alt="${data.product.productName}">
                                          <div class="ml-3">
                                              <p>Quantity: ${data.product.quantity}</p>
                                              <p>Price: ₹${data.order.totalAmount}</p>
                                          </div>
                                      </div>
                                  </div>

                                  ${data.order.status === 'Pending' || data.order.status === 'Shipped' || data.order.status === 'Processing' 
                                      ? `<button onclick="confirmCancelOrder('${data.order._id}')" 
                                                class="btn btn-danger mt-3">
                                           Cancel Order
                                         </button>`
                                      : ''}
                                  
                                  ${data.order.status === 'Delivered'
                                      ? `<button onclick="confirmReturnOrder('${data.order._id}')" 
                                                class="btn btn-warning mt-3">
                                           Return Order
                                         </button>`
                                      : ''}
                              </div>
                          </div>
                      </div>
                  `;
                  detailsContent.innerHTML = html;
              } else {
                  detailsContent.innerHTML = 'Error loading order details';
              }
          })
          .catch(error => {
              console.error('Error:', error);
              detailsContent.innerHTML = 'Error loading order details';
          });
  }

  function confirmCancelOrder(orderId) {
      // ... existing cancel order code ...
  }

  function confirmReturnOrder(orderId) {
      // ... existing return order code ...
  }

  // Pagination configuration
  const itemsPerPage = 5;
  let currentPage = 1;
  
  // Get all transactions with safety check
  const allTransactions = <%- JSON.stringify((wallet && wallet.transactions) || []) %>;
  const totalPages = Math.ceil(allTransactions.length / itemsPerPage);

  function displayTransactions(page) {
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, allTransactions.length);
    const transactionsToShow = allTransactions.slice(startIndex, endIndex);

    const tableBody = document.getElementById('transactionTableBody');
    tableBody.innerHTML = '';

    transactionsToShow.forEach(transaction => {
      const row = document.createElement('tr');
      // Use a default 'N/A' if transactionId is not available (for compatibility with existing data)
      const transactionId = transaction.transactionId || `TXN${Math.floor(Math.random() * 1000000)}`;
      
      row.innerHTML = `
        <td>${transactionId}</td>
        <td>${new Date(transaction.date).toLocaleDateString()}</td>
        <td>${transaction.description}</td>
        <td>
          <span class="badge ${transaction.type === 'credit' ? 'bg-success' : 'bg-danger'}">
            ${transaction.type.toUpperCase()}
          </span>
        </td>
        <td>₹${transaction.amount}</td>
      `;
      tableBody.appendChild(row);
    });

    // Update pagination info
    document.getElementById('startIndex').textContent = startIndex + 1;
    document.getElementById('endIndex').textContent = endIndex;
    document.getElementById('totalItems').textContent = allTransactions.length;

    // Update button states
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
  }

  // Event listeners for pagination buttons
  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      displayTransactions(currentPage);
    }
  });

  document.getElementById('nextPage').addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++;
      displayTransactions(currentPage);
    }
  });

  // Initialize the display
  displayTransactions(1);

  // Referral code and link copy functions
  function copyReferralCode() {
    const codeElement = document.getElementById('referralCode');
    codeElement.select();
    document.execCommand('copy');
    
    const copyBtn = document.getElementById('copyCodeBtn');
    copyBtn.innerHTML = '<i class="fi-rs-check"></i> Copied';
    setTimeout(() => {
      copyBtn.innerHTML = '<i class="fi-rs-copy"></i> Copy';
    }, 2000);
  }
  
  function copyReferralLink() {
    const linkElement = document.getElementById('referralLink');
    linkElement.select();
    document.execCommand('copy');
    
    const copyBtn = document.getElementById('copyLinkBtn');
    copyBtn.innerHTML = '<i class="fi-rs-check"></i> Copied';
    setTimeout(() => {
      copyBtn.innerHTML = '<i class="fi-rs-copy"></i> Copy';
    }, 2000);
  }
  
  // Social sharing functions
  function shareOnWhatsApp() {
    const referralLink = document.getElementById('referralLink').value;
    const message = "Join me on Oxyboo! Use my referral code and get exclusive offers: " + referralLink;
    const whatsappUrl = "https://api.whatsapp.com/send?text=" + encodeURIComponent(message);
    window.open(whatsappUrl, '_blank');
  }
  
  function shareOnFacebook() {
    const referralLink = document.getElementById('referralLink').value;
    const facebookUrl = "https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(referralLink);
    window.open(facebookUrl, '_blank');
  }
  
  function shareOnTwitter() {
    const referralLink = document.getElementById('referralLink').value;
    const message = "Join me on Oxyboo! Use my referral link and get exclusive offers:";
    const twitterUrl = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(message) + "&url=" + encodeURIComponent(referralLink);
    window.open(twitterUrl, '_blank');
  }
  </script>

  <%- include("../../views/partials/user/footer") %>